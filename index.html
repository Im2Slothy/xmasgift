<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Mr. Frog's Christmas: Mobile Edition</title>
<link rel="icon" type="image/webp" href="img/mrfrog.webp">

<style>
    body {
        margin: 0;
        overflow: hidden; /* Prevents scrollbars */
        background-color: #051e05; 
        font-family: 'Courier New', Courier, monospace;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        touch-action: none; /* Disables browser gestures */
        -webkit-user-select: none; /* Disables text selection on iPhone */
        user-select: none;
    }
    #gameContainer {
        position: relative;
        box-shadow: 0 0 50px rgba(0,255,0,0.4);
        border: 4px solid #2e8b57;
        /* Make game responsive */
        width: 100%;
        max-width: 1024px;
        aspect-ratio: 1024/640; 
    }
    #gameCanvas {
        display: block;
        background-color: #222; 
        width: 100%;
        height: 100%;
    }
    #ui {
        position: absolute;
        top: 10px;
        left: 10px;
        color: white;
        font-size: 20px; /* Scaled text */
        font-weight: bold;
        text-shadow: 2px 2px 0 #000;
        pointer-events: none;
        z-index: 5;
    }
    /* SCREENS */
    .screen {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: #0f0;
        text-align: center;
        z-index: 10;
    }
    h1 { font-size: 5vw; margin-bottom: 10px; text-shadow: 0 0 10px #0f0; }
    p { font-size: 3vw; color: white; margin-bottom: 5px; }
    button {
        margin-top: 30px;
        padding: 15px 30px;
        font-size: 24px;
        cursor: pointer;
        background: #0f0;
        border: 2px solid white;
        border-radius: 5px;
        font-weight: bold;
        color: black;
        transition: transform 0.1s;
    }
    button:active { transform: scale(0.95); background: #fff; }
    #winScreen { display: none; }

    /* MOBILE CONTROLS */
    #mobileControls {
        position: absolute;
        bottom: 20px;
        left: 0;
        width: 100%;
        height: 100px;
        z-index: 20;
        display: flex; /* Hidden by default if we wanted, but let's show always for safety */
        justify-content: space-between;
        padding: 0 20px;
        box-sizing: border-box;
        pointer-events: none; /* Let clicks pass through empty space */
    }
    .control-btn {
        pointer-events: auto; /* Re-enable clicks on buttons */
        width: 80px;
        height: 80px;
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.5);
        border-radius: 50%;
        color: white;
        font-size: 30px;
        display: flex;
        justify-content: center;
        align-items: center;
        user-select: none;
        touch-action: none;
    }
    .control-btn:active {
        background: rgba(0, 255, 0, 0.5);
    }
    .left-controls {
        display: flex;
        gap: 20px;
    }
</style>
</head>
<body>

<div id="gameContainer">
    <div id="ui">SCORE: <span id="scoreVal">0</span> | BUGS: <span id="bugsVal">0</span></div>
    <canvas id="gameCanvas" width="1024" height="640"></canvas>

    <div id="mobileControls">
        <div class="left-controls">
            <div class="control-btn" id="btnLeft">←</div>
            <div class="control-btn" id="btnRight">→</div>
        </div>
        <div class="control-btn" id="btnJump" style="background: rgba(255,0,0,0.2);">JUMP</div>
    </div>

    <div id="startScreen" class="screen">
        <h1>MR FROG'S CHRISTMAS!</h1>
        <p>DIAMOND EDITION</p>
        <p style="font-size: 14px; color: #aaa;">Turn phone sideways!</p>
        <button onclick="startGame()">START SHOW</button>
    </div>

    <div id="winScreen" class="screen">
        <h1>HELLO. I WON THE SHOW.</h1>
        <p>Final Score: <span id="finalScore">0</span></p>
        <p>Tell the Producer I said hello.</p>
        <p>Merry Christmas, Maizie! <3</p>
        <button onclick="location.reload()">EAT BUG AGAIN</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('scoreVal');
    const bugsEl = document.getElementById('bugsVal');
    
    // --- AUDIO ---
    const sndIntro = new Audio('audio/intro.mp3'); 
    const sndEat = new Audio('audio/eat.mp3');     
    const sndStomp = new Audio('audio/stomp.mp3'); 

    // --- IMAGES ---
    const bgImage = new Image();     bgImage.src = 'img/bg.png';
    const playerImg = new Image();   playerImg.src = 'img/mrfrog.webp';
    const bugImg = new Image();      bugImg.src = 'img/bug.webp';
    const enemyImg = new Image();    enemyImg.src = 'img/blibiles.webp';
    const producerImg = new Image(); producerImg.src = 'img/producer.png';
    const treeImg = new Image();     treeImg.src = 'img/tree.png';

    let assetsLoaded = false;
    bgImage.onload = function() { assetsLoaded = true; };

    // --- GAME STATE ---
    let gameRunning = false;
    let score = 0;
    let bugsEaten = 0;
    let cameraX = 0;
    
    // CHECKPOINT: Moved to top of stairs (x: 2420)
    let checkpointActive = false;
    let checkpointTimer = 0;
    const checkpoint = {x: 2420, y: 190, w: 60, h: 60}; 

    // --- PLAYER PHYSICS ---
    const player = {
        x: 100, y: 300, width: 50, height: 50,
        dx: 0, dy: 0, 
        speed: 5.5, 
        jumpPower: -15, 
        grounded: false, facingRight: true,
        jumpCount: 0, maxJumps: 2
    };

    const gravity = 0.7; 
    const friction = 0.85;

    // --- CONTROLS LOGIC ---
    const keys = [];

    // KEYBOARD LISTENERS
    window.addEventListener('keydown', e => handleInput(e.code, true));
    window.addEventListener('keyup', e => handleInput(e.code, false));

    // TOUCH LISTENERS
    const btnLeft = document.getElementById('btnLeft');
    const btnRight = document.getElementById('btnRight');
    const btnJump = document.getElementById('btnJump');

    function addTouchHandler(element, code) {
        element.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(code, true); });
        element.addEventListener('touchend', (e) => { e.preventDefault(); handleInput(code, false); });
    }

    addTouchHandler(btnLeft, 'ArrowLeft');
    addTouchHandler(btnRight, 'ArrowRight');
    addTouchHandler(btnJump, 'ArrowUp');

    function handleInput(code, isPressed) {
        keys[code] = isPressed;
        // Jump Logic on Press only
        if (isPressed && (code === 'ArrowUp' || code === 'KeyW' || code === 'Space')) {
            if (player.grounded) {
                player.dy = player.jumpPower;
                player.grounded = false;
                player.jumpCount = 1;
            } else if (player.jumpCount < player.maxJumps) {
                player.dy = player.jumpPower; // Double Jump
                player.jumpCount++;
                spawnParticles(player.x + 25, player.y + 50, 'white');
            }
        }
    }

    // --- PARTICLES ---
    let particles = [];
    class Particle {
        constructor(x, y, color) {
            this.x = x; this.y = y; this.color = color;
            this.size = Math.random() * 5 + 2;
            this.dx = (Math.random() - 0.5) * 10;
            this.dy = (Math.random() - 0.5) * 10;
            this.life = 1.0; 
        }
        update() {
            this.x += this.dx;
            this.y += this.dy;
            this.life -= 0.02; 
            this.dy += 0.5; 
        }
        draw(ctx) {
            ctx.globalAlpha = this.life;
            ctx.fillStyle = this.color;
            ctx.fillRect(this.x, this.y, this.size, this.size);
            ctx.globalAlpha = 1.0;
        }
    }
    function spawnParticles(x, y, color) {
        for(let i=0; i<15; i++) particles.push(new Particle(x, y, color));
    }

    // --- SNOWFLAKES ---
    let snow = [];
    for(let i=0; i<100; i++) {
        snow.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            r: Math.random() * 3 + 1,
            speed: Math.random() * 2 + 1
        });
    }

    // --- LEVEL DESIGN ---
    let platforms = [
        // --- SECTION 1: SWAMP ---
        {x: 0, y: 600, w: 800, h: 40}, 
        {x: 300, y: 450, w: 100, h: 20},
        {x: 500, y: 350, w: 100, h: 20},
        {x: 800, y: 400, w: 120, h: 20, moving: true, type: 'h', range: 200, speed: 2, startX: 800},
        {x: 1100, y: 400, w: 100, h: 20}, 
        {x: 1300, y: 550, w: 400, h: 20}, 
        
        // --- SECTION 2: MOUNTAIN ---
        {x: 1800, y: 550, w: 150, h: 20}, 
        {x: 2000, y: 450, w: 100, h: 20},
        {x: 2150, y: 350, w: 100, h: 20},
        {x: 2300, y: 250, w: 200, h: 20}, // Checkpoint Platform
        
        // ELEVATOR
        {x: 2550, y: 500, w: 120, h: 20, moving: true, type: 'v', range: 400, speed: 3, startY: 500},

        // --- SECTION 3: SKY ---
        {x: 2700, y: 100, w: 200, h: 20}, 
        {x: 3000, y: 100, w: 100, h: 20, moving: true, type: 'h', range: 150, speed: 3, startX: 3000},
        {x: 3300, y: 150, w: 150, h: 20}, 
        {x: 3600, y: 250, w: 100, h: 20}, 
        {x: 3800, y: 400, w: 100, h: 20},
        {x: 4000, y: 500, w: 100, h: 20},
        
        // --- SECTION 4: THE LAVA ZONE ---
        {x: 4200, y: 600, w: 500, h: 40}, 
        {x: 4800, y: 500, w: 100, h: 20},
        {x: 5000, y: 400, w: 100, h: 20},
        // Pit of spikes
        {x: 5200, y: 500, w: 100, h: 20, moving: true, type: 'h', range: 200, speed: 4, startX: 5200},
        {x: 5600, y: 350, w: 100, h: 20},
        {x: 5900, y: 250, w: 100, h: 20},
        // Final floor
        {x: 6100, y: 400, w: 800, h: 40}, 
    ];

    const spikes = [
        {x: 1400, y: 520}, {x: 1440, y: 520}, {x: 1480, y: 520},
        {x: 4700, y: 610}, {x: 4750, y: 610}, 
        {x: 5500, y: 610}, {x: 5550, y: 610}, {x: 5600, y: 610},
    ];

    let enemies = [
        {x: 600, y: 550, w: 40, h: 40, dx: 2, speed: 2, alive: true, minX: 550, maxX: 750},
        {x: 1350, y: 510, w: 40, h: 40, dx: 3, speed: 3, alive: true, minX: 1300, maxX: 1600},
        {x: 2700, y: 60, w: 40, h: 40, dx: 2, speed: 2, alive: true, minX: 2700, maxX: 2850},
        {x: 4200, y: 560, w: 40, h: 40, dx: 5, speed: 5, alive: true, minX: 4200, maxX: 4600},
        {x: 6200, y: 360, w: 40, h: 40, dx: 6, speed: 6, alive: true, minX: 6100, maxX: 6500}
    ];

    let bugs = [
        {x: 330, y: 410, w: 30, h: 30, collected: false},
        {x: 950, y: 350, w: 30, h: 30, collected: false},
        {x: 1450, y: 450, w: 30, h: 30, collected: false},
        {x: 2330, y: 210, w: 30, h: 30, collected: false},
        {x: 2530, y: 200, w: 30, h: 30, collected: false},
        {x: 3350, y: 110, w: 30, h: 30, collected: false},
        {x: 4530, y: 460, w: 30, h: 30, collected: false},
        {x: 5020, y: 360, w: 30, h: 30, collected: false},
        {x: 6300, y: 360, w: 30, h: 30, collected: false},
    ];

    let goal = {x: 6600, y: 300, w: 100, h: 100, startY: 300, speed: 2, dy: 2}; 

    function startGame() {
        document.getElementById('startScreen').style.display = 'none';
        gameRunning = true;
        sndIntro.volume = 0.5;
        sndIntro.play().catch(e => console.log("Audio issue:", e));
        loop();
    }

    function update() {
        // 1. PARTICLES & TIMER
        for(let i = particles.length - 1; i >= 0; i--) {
            particles[i].update();
            if(particles[i].life <= 0) particles.splice(i, 1);
        }
        if (checkpointTimer > 0) checkpointTimer--;

        // 2. BOSS MOVEMENT
        goal.y += goal.dy;
        if (goal.y > goal.startY + 100 || goal.y < goal.startY - 100) goal.dy *= -1;

        // 3. MOVING PLATFORMS
        for (let p of platforms) {
            if (p.moving) {
                if (p.type === 'h') {
                    p.x += p.speed;
                    if (p.x > p.startX + p.range || p.x < p.startX) p.speed *= -1;
                    if (player.grounded && player.y + player.height === p.y && 
                        player.x + player.width > p.x && player.x < p.x + p.w) {
                        player.x += p.speed;
                    }
                } else if (p.type === 'v') {
                    p.y += p.speed;
                    if (p.y > p.startY || p.y < p.startY - p.range) p.speed *= -1;
                     if (player.grounded && player.y + player.height >= p.y - 5 && player.y + player.height <= p.y + 5 &&
                        player.x + player.width > p.x && player.x < p.x + p.w) {
                        player.y += p.speed;
                    }
                }
            }
        }

        // 4. PLAYER PHYSICS
        if (keys['ArrowRight'] || keys['KeyD']) {
            player.dx = player.speed;
            player.facingRight = true;
        } else if (keys['ArrowLeft'] || keys['KeyA']) {
            player.dx = -player.speed;
            player.facingRight = false;
        } else {
            player.dx *= friction;
        }

        player.dy += gravity;
        player.x += player.dx;
        player.y += player.dy;

        // 5. COLLISIONS
        player.grounded = false;
        for (let p of platforms) {
            let dir = colCheck(player, p);
            if (dir === "b") {
                player.grounded = true;
                player.jumpCount = 0; // Reset jumps
                player.dy = 0;
            } else if (dir === "t") {
                player.dy = 0; 
            }
        }

        // 6. SPIKES
        for (let s of spikes) {
            if (player.x + player.width > s.x + 5 && player.x < s.x + 25 &&
                player.y + player.height > s.y + 10 && player.y < s.y + 30) {
                resetPlayer();
            }
        }

        // 7. ENEMIES
        for (let e of enemies) {
            if (!e.alive) continue;
            e.x += e.dx;
            if (e.x > e.maxX) { e.dx = -e.speed; e.x = e.maxX; }
            if (e.x < e.minX) { e.dx = e.speed; e.x = e.minX; }
            
            let dir = colCheck(player, e);
            if (dir === "b") { 
                e.alive = false;
                player.dy = -10; 
                score += 500;
                scoreEl.innerText = score;
                sndStomp.currentTime = 0;
                sndStomp.play();
                spawnParticles(e.x + e.w/2, e.y + e.h/2, 'red');
            } else if (dir === "t" || dir === "l" || dir === "r") {
                resetPlayer();
            }
        }

        // 8. BUGS
        for (let b of bugs) {
            if (!b.collected && colCheck(player, b)) {
                b.collected = true;
                score += 100;
                bugsEaten++;
                scoreEl.innerText = score;
                bugsEl.innerText = bugsEaten;
                sndEat.currentTime = 0;
                sndEat.play();
                spawnParticles(b.x + b.w/2, b.y + b.h/2, 'violet');
            }
        }
        
        // 9. CHECKPOINT LOGIC
        if (!checkpointActive) {
            if(colCheck(player, checkpoint)) {
                   checkpointActive = true;
                   checkpointTimer = 180; 
                   let cpSound = new Audio('audio/eat.mp3');
                   cpSound.volume = 0.5;
                   cpSound.play();
            }
        }

        // 10. CAMERA
        let targetCamX = player.x - canvas.width / 3;
        if (targetCamX < 0) targetCamX = 0;
        if (targetCamX > 7000 - canvas.width) targetCamX = 7000 - canvas.width;
        cameraX += (targetCamX - cameraX) * 0.1;

        // 11. WIN/LOSS
        if (player.y > canvas.height + 200) resetPlayer();
        if (colCheck(player, goal)) gameWin();
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Background Tiling
        if (assetsLoaded) {
            let bgW = bgImage.width; 
            let parallaxX = (cameraX * 0.5) % bgW; 
            for (let i = -1; i < 8; i++) { 
                ctx.drawImage(bgImage, (i * bgW) - parallaxX, -50); 
            }
        } else {
            ctx.fillStyle = "#222";
            ctx.fillRect(0,0,canvas.width,canvas.height);
        }

        ctx.save();
        ctx.translate(-Math.floor(cameraX), 0);

        // SPIKES
        ctx.fillStyle = "red";
        for (let s of spikes) {
            ctx.beginPath();
            ctx.moveTo(s.x, s.y + 30); 
            ctx.lineTo(s.x + 15, s.y); 
            ctx.lineTo(s.x + 30, s.y + 30); 
            ctx.fill();
        }

        // CHECKPOINT (Using tree.png)
        if (assetsLoaded) {
            ctx.drawImage(treeImg, checkpoint.x, checkpoint.y, checkpoint.w, checkpoint.h);
        } else {
            ctx.fillStyle = "green";
            ctx.fillRect(checkpoint.x, checkpoint.y, checkpoint.w, checkpoint.h);
        }

        // PLATFORMS
        for (let p of platforms) {
            ctx.fillStyle = p.moving ? "#8B0000" : "#5C4033"; 
            ctx.fillRect(p.x, p.y, p.w, p.h);
            ctx.fillStyle = p.moving ? "#ff0000" : "#8B4513";
            ctx.fillRect(p.x, p.y, p.w, 5);
        }

        // GOAL
        if (assetsLoaded) {
            ctx.drawImage(producerImg, goal.x, goal.y, goal.w, goal.h);
            ctx.fillStyle = "white";
            ctx.font = "bold 16px Arial";
            ctx.fillText("PRODUCER", goal.x + 10, goal.y - 10);
        } else {
            ctx.fillStyle = "gold";
            ctx.fillRect(goal.x, goal.y, goal.w, goal.h);
        }

        // BUGS
        for (let b of bugs) {
            if (!b.collected) ctx.drawImage(bugImg, b.x, b.y, b.w, b.h);
        }

        // ENEMIES
        for (let e of enemies) {
            if (e.alive) {
                ctx.save();
                if(e.dx > 0) {
                    ctx.translate(e.x + e.w, e.y);
                    ctx.scale(-1, 1);
                    ctx.drawImage(enemyImg, 0, 0, e.w, e.h);
                } else {
                    ctx.drawImage(enemyImg, e.x, e.y, e.w, e.h);
                }
                ctx.restore();
            }
        }
        
        // PARTICLES
        for (let p of particles) {
            p.draw(ctx);
        }

        // PLAYER
        ctx.save();
        if (!player.facingRight) {
            ctx.translate(player.x + player.width, player.y);
            ctx.scale(-1, 1);
            ctx.drawImage(playerImg, 0, 0, player.width, player.height);
        } else {
            ctx.drawImage(playerImg, player.x, player.y, player.width, player.height);
        }
        ctx.restore();

        ctx.restore();
        
        // SNOW
        ctx.fillStyle = "white";
        for (let s of snow) {
            ctx.beginPath();
            ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
            ctx.fill();
            s.y += s.speed;
            s.x += Math.sin(s.y * 0.01) * 0.5; 
            if (s.y > canvas.height) s.y = -5;
            if (s.x > canvas.width) s.x = 0;
            if (s.x < 0) s.x = canvas.width;
        }

        // UI OVERLAYS
        if (checkpointTimer > 0) {
            ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
            ctx.fillRect(0, canvas.height/2 - 50, canvas.width, 100);
            ctx.fillStyle = "#0f0";
            ctx.font = "bold 48px Courier New";
            ctx.textAlign = "center";
            ctx.fillText("PROGRESS SAVED!", canvas.width/2, canvas.height/2 + 15);
            ctx.textAlign = "start"; 
        }
    }

    function resetPlayer() {
        if (checkpointActive) {
            player.x = checkpoint.x;
            player.y = checkpoint.y - 20; 
        } else {
            player.x = 100;
            player.y = 300;
        }
        player.dx = 0; player.dy = 0;
        score = Math.max(0, score - 200);
        scoreEl.innerText = score;
    }

    function gameWin() {
        gameRunning = false;
        document.getElementById('finalScore').innerText = score;
        document.getElementById('winScreen').style.display = 'flex';
    }

    function colCheck(shapeA, shapeB) {
        let vX = (shapeA.x + (shapeA.width / 2)) - (shapeB.x + (shapeB.w / 2)),
            vY = (shapeA.y + (shapeA.height / 2)) - (shapeB.y + (shapeB.h / 2)),
            hWidths = (shapeA.width / 2) + (shapeB.w / 2),
            hHeights = (shapeA.height / 2) + (shapeB.h / 2),
            colDir = null;

        if (Math.abs(vX) < hWidths && Math.abs(vY) < hHeights) {
            let oX = hWidths - Math.abs(vX), oY = hHeights - Math.abs(vY);
            if (oX >= oY) {
                if (vY > 0) { colDir = "t"; shapeA.y += oY; } 
                else { colDir = "b"; shapeA.y -= oY; }
            } else {
                if (vX > 0) { colDir = "l"; shapeA.x += oX; } 
                else { colDir = "r"; shapeA.x -= oX; }
            }
        }
        return colDir;
    }

    function loop() {
        if (!gameRunning) return;
        update();
        draw();
        requestAnimationFrame(loop);
    }
</script>
</body>
</html>
